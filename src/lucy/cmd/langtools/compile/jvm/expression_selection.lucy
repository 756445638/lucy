
import "lucy/cmd/langtools/compile/ast"
import "lucy/cmd/langtools/compile/jvm/cg"


class BuildExpressionSelection {
    

    eb BuildExpression
    
    fn BuildExpressionSelection(eb BuildExpression){
        this.super()
        this.eb = eb
    }


    fn buildSelection(
        c cg.ClassHighLevel,
        code cg.AttributeCode,
        e ast.Expression,
        context Context,
        state StackMapState) -> (maxStack char) {
        selection := e.data.(ast.ExpressionSelection)

        // check cast to super class
        if selection.name == ast.SUPER {
            maxStack = this.eb.build(c, code, selection.Expression, context, state)
            return
        }
        if selection.Method != null { // pack to method handle
            code.Codes[code.CodeLength] = cg.OP_invokestatic
            c.InsertMethodRefConst(new cg.ConstantInfoMethodrefHighLevel(
                "java/lang/invoke/MethodHandles",
                "lookup",
                "()Ljava/lang/invoke/MethodHandles$Lookup;"
            ), code.Codes[code.CodeLength+1:code.CodeLength+3])
            code.CodeLength += 3
            code.Codes[code.CodeLength] = cg.OP_ldc_w
            c.InsertClassConst(selection.Expression.value.Class.name,
                code.Codes[code.CodeLength+1:code.CodeLength+3])
            code.CodeLength += 3
            code.Codes[code.CodeLength] = cg.OP_ldc_w
            c.InsertStringConst(selection.name, code.Codes[code.CodeLength+1:code.CodeLength+3])
            code.CodeLength += 3
            code.Codes[code.CodeLength] = cg.OP_ldc_w
            c.InsertMethodTypeConst(new cg.ConstantInfoMethodTypeHighLevel(
                Descriptor.methodDescriptor(selection.Method.Function.Type)
            ), code.Codes[code.CodeLength+1:code.CodeLength+3])
            code.CodeLength += 3
            code.Codes[code.CodeLength] = cg.OP_invokevirtual
            if selection.Method.IsStatic() {
                c.InsertMethodRefConst(new cg.ConstantInfoMethodrefHighLevel(
                    "java/lang/invoke/MethodHandles$Lookup",
                    "findStatic",
                    "(Ljava/lang/Class;Ljava/lang/String;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/MethodHandle;"
                ), code.Codes[code.CodeLength+1:code.CodeLength+3])
            } else {
                c.InsertMethodRefConst(new cg.ConstantInfoMethodrefHighLevel(
                    "java/lang/invoke/MethodHandles$Lookup",
                    "findVirtual",
                    "(Ljava/lang/Class;Ljava/lang/String;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/MethodHandle;"
                ), code.Codes[code.CodeLength+1:code.CodeLength+3])
            }
            code.CodeLength += 3
            if 4 > maxStack {
                maxStack = 4
            }
            if selection.Expression.value.Type == ast.VariableTypeObject {
                stack := this.eb.build(c, code, selection.Expression, context, state)
                if t := char(1) + stack; t > maxStack {
                    maxStack = t
                }
                code.Codes[code.CodeLength] = cg.OP_invokevirtual
                c.InsertMethodRefConst(new cg.ConstantInfoMethodrefHighLevel(
                    "java/lang/invoke/MethodHandle",
                    "bindTo",
                    "(Ljava/lang/Object;)Ljava/lang/invoke/MethodHandle;"
                ), code.Codes[code.CodeLength+1:code.CodeLength+3])
                code.CodeLength += 3
            }
            return
        }

        switch selection.Expression.value.Type {
        case ast.VariableTypePackage:
            if selection.PackageVariable != null {
                maxStack = jvmSlotSize(e.value)
                if selection.PackageVariable.jvmDescriptor == "" {
                    selection.PackageVariable.jvmDescriptor = Descriptor.typeDescriptor(e.value)
                }
                code.Codes[code.CodeLength] = cg.OP_getstatic
                c.InsertFieldRefConst(new cg.ConstantInfoFieldrefHighLevel(
                    selection.Expression.value.Package.name + "/main",
                    selection.PackageVariable.name,
                    selection.PackageVariable.jvmDescriptor
                ), code.Codes[code.CodeLength+1:code.CodeLength+3])
                code.CodeLength += 3
                return
            }
            if selection.PackageEnumName != null {
                loadInt32(c, code, selection.PackageEnumName.value)
                maxStack = 1
                return
            }
            if selection.PackageFunction != null { // pack to method handle
                code.Codes[code.CodeLength] = cg.OP_invokestatic
                c.InsertMethodRefConst(new cg.ConstantInfoMethodrefHighLevel(
                    "java/lang/invoke/MethodHandles",
                    "lookup",
                    "()Ljava/lang/invoke/MethodHandles$Lookup;"
                ), code.Codes[code.CodeLength+1:code.CodeLength+3])
                code.CodeLength += 3
                code.Codes[code.CodeLength] = cg.OP_ldc_w
                c.InsertClassConst(selection.Expression.value.Package.name+"/main",
                    code.Codes[code.CodeLength+1:code.CodeLength+3])
                code.CodeLength += 3
                code.Codes[code.CodeLength] = cg.OP_ldc_w
                c.InsertStringConst(selection.name, code.Codes[code.CodeLength+1:code.CodeLength+3])
                code.CodeLength += 3
                code.Codes[code.CodeLength] = cg.OP_ldc_w
                c.InsertMethodTypeConst(new cg.ConstantInfoMethodTypeHighLevel(
                     Descriptor.methodDescriptor(selection.PackageFunction.Type)
                ), code.Codes[code.CodeLength+1:code.CodeLength+3])
                code.CodeLength += 3
                code.Codes[code.CodeLength] = cg.OP_invokevirtual
                c.InsertMethodRefConst(new cg.ConstantInfoMethodrefHighLevel(
                    "java/lang/invoke/MethodHandles$Lookup",
                    "findStatic",
                    "(Ljava/lang/Class;Ljava/lang/String;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/MethodHandle;"
                ), code.Codes[code.CodeLength+1:code.CodeLength+3])
                code.CodeLength += 3
                if 4 > maxStack {
                    maxStack = 4
                }
                return
            }
        case ast.VariableTypeDynamicSelector:
            if selection.Field != null {
                if selection.Field.IsStatic() == false {
                    code.Codes[code.CodeLength] = cg.OP_aload_0
                    code.CodeLength++
                    if 1 > maxStack {
                        maxStack = 1
                    }
                    code.Codes[code.CodeLength] = cg.OP_getfield
                    code.CodeLength++
                } else {
                    code.Codes[code.CodeLength] = cg.OP_getstatic
                    code.CodeLength++
                }
                if selection.Field.jvmDescriptor == "" {
                    selection.Field.jvmDescriptor = Descriptor.typeDescriptor(selection.Field.Type)
                }
                c.InsertFieldRefConst(new cg.ConstantInfoFieldrefHighLevel(
                    selection.Expression.value.Class.name,
                    selection.name,
                    selection.Field.jvmDescriptor
                ),
                    code.Codes[code.CodeLength:code.CodeLength+2])
                code.CodeLength += 2
            } else {
                code.Codes[code.CodeLength] = cg.OP_invokestatic
                c.InsertMethodRefConst(new cg.ConstantInfoMethodrefHighLevel(
                    "java/lang/invoke/MethodHandles",
                    "lookup",
                    "()Ljava/lang/invoke/MethodHandles$Lookup;"
                ), code.Codes[code.CodeLength+1:code.CodeLength+3])
                code.CodeLength += 3
                code.Codes[code.CodeLength] = cg.OP_ldc_w
                c.InsertClassConst(selection.Expression.value.Class.name, code.Codes[code.CodeLength+1:code.CodeLength+3])
                code.CodeLength += 3
                code.Codes[code.CodeLength] = cg.OP_ldc_w
                c.InsertStringConst(selection.name, code.Codes[code.CodeLength+1:code.CodeLength+3])
                code.CodeLength += 3
                code.Codes[code.CodeLength] = cg.OP_ldc_w
                c.InsertMethodTypeConst(new cg.ConstantInfoMethodTypeHighLevel(
                    Descriptor.methodDescriptor(selection.Method.Function.Type)
                ), code.Codes[code.CodeLength+1:code.CodeLength+3])
                code.CodeLength += 3
                code.Codes[code.CodeLength] = cg.OP_invokevirtual
                if selection.Method.IsStatic() {
                    c.InsertMethodRefConst(new cg.ConstantInfoMethodrefHighLevel(
                        "java/lang/invoke/MethodHandles$Lookup",
                        "findStatic",
                        "(Ljava/lang/Class;Ljava/lang/String;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/MethodHandle;"
                    ), code.Codes[code.CodeLength+1:code.CodeLength+3])
                } else {
                    c.InsertMethodRefConst(new cg.ConstantInfoMethodrefHighLevel(
                        "java/lang/invoke/MethodHandles$Lookup",
                        "findVirtual",
                        "(Ljava/lang/Class;Ljava/lang/String;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/MethodHandle;"
                    ), code.Codes[code.CodeLength+1:code.CodeLength+3])
                }
                code.CodeLength += 3
                if 4 > maxStack {
                    maxStack = 4
                }
                if selection.Method.IsStatic() == false {
                    code.Codes[code.CodeLength] = cg.OP_aload_0
                    code.CodeLength++
                    code.Codes[code.CodeLength] = cg.OP_invokevirtual
                    c.InsertMethodRefConst(new cg.ConstantInfoMethodrefHighLevel(
                        "java/lang/invoke/MethodHandle",
                        "bindTo",
                        "(Ljava/lang/Object;)Ljava/lang/invoke/MethodHandle;"
                    ), code.Codes[code.CodeLength+1:code.CodeLength+3])
                    code.CodeLength += 3
                }
            }
            return
        case ast.VariableTypeClass:
            maxStack = jvmSlotSize(e.value)
            code.Codes[code.CodeLength] = cg.OP_getstatic
            c.InsertFieldRefConst(new cg.ConstantInfoFieldrefHighLevel(
                selection.Expression.value.Class.name,
                selection.name,
                Descriptor.typeDescriptor(e.value)
            ), code.Codes[code.CodeLength+1:code.CodeLength+3])
            code.CodeLength += 3
            return
        case ast.VariableTypeObject:
            // object
            stack := this.eb.build(c, code, selection.Expression, context, state)
            if stack > maxStack {
                maxStack = stack
            }
            code.Codes[code.CodeLength] = cg.OP_getfield
            c.InsertFieldRefConst(new cg.ConstantInfoFieldrefHighLevel(
                selection.Expression.value.Class.name,
                selection.name,
                Descriptor.typeDescriptor(e.value)
            ), code.Codes[code.CodeLength+1:code.CodeLength+3])
            code.CodeLength += 3
            if t := jvmSlotSize(e.value); t > maxStack {
                maxStack = t
            }
            return
        }
        return

    }

}

